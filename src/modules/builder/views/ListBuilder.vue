<template>
  <div v-if="!loading" class="list-builder-view">
    <div class="header-bar">
      <div style="flex: 1; min-width: 0; display: flex; align-items: center">
        <BackButton />
      </div>
      <div class="floating-header-buttons">
        <CircleIconButton
          class="export-btn"
          :size="36"
          icon="fa-solid fa-file-arrow-down"
          @click="openExport" />
        <SettingsButton class="settings-btn" :size="36" @click="openSettings" />
      </div>
    </div>
    <h1 class="list-title" v-if="list">{{ list.name }}</h1>
    <div v-if="list" class="subheader">{{ list.faction }}</div>
    <div v-else class="not-found">List not found.</div>
    <Section
      v-if="army.battleTraits.length > 0"
      :default-collapsed="battleTraitsCollapsed"
      collapseKey="battleTraits">
      <template #title>Battle Traits</template>
      <AbilityCard v-for="(trait, i) in army.battleTraits" :key="trait.name + i" :ability="trait" />
    </Section>
    <Section
      v-if="army.formations.size > 0"
      :default-collapsed="formationCollapsed"
      collapseKey="formations">
      <template #title>{{ list.formation || 'Formations' }}</template>
      <div class="formation-section">
        <OptionSelect v-model="list.formation" :options="Array.from(army.formations.keys())" />
        <div>
          <AbilityCard
            v-for="(ability, i) in selectedFormation"
            :key="ability.name + i"
            :ability="ability" />
        </div>
      </div>
    </Section>
    <Section :defaultCollapsed="battleTacticCardsCollapsed" collapseKey="battleTacticCards">
      <template #title>Battle Tactic Cards</template>
      <div class="battle-tactic-selectors">
        <div class="battle-tactic-selector">
          <OptionSelect
            v-model="list.battleTacticCard1"
            :options="battleTacticCards.map((card) => card.name)"
            placeholder="Select Battle Tactic Card 1" />
          <BattleTacticCard
            v-if="selectedBattleTacticCard1.name.length > 0"
            :card="selectedBattleTacticCard1" />
        </div>
        <div class="battle-tactic-selector">
          <OptionSelect
            v-model="list.battleTacticCard2"
            :options="battleTacticCards.map((card) => card.name)"
            placeholder="Select Battle Tactic Card 2" />
          <BattleTacticCard
            v-if="selectedBattleTacticCard2.name.length > 0"
            :card="selectedBattleTacticCard2" />
        </div>
      </div>
    </Section>
    <div v-if="list && army.battleProfiles.size > 0">
      <div v-for="(regiment, idx) in list.regiments" :key="idx" class="regiment-block">
        <ListRegiment
          :regimentIdx="idx"
          :regiment="regiment"
          :listId="list.id"
          :battleProfiles="army.battleProfiles"
          :armyName="list.faction"
          @delete="() => deleteRegiment(idx)"
          @delete-unit="(unitIdx) => handleDeleteUnit(idx, unitIdx)" />
      </div>
      <button class="add-regiment-btn" @click="addRegiment">Add regiment</button>

      <AuxiliaryUnitsSection
        v-model="list.auxiliaryUnits"
        :battleProfiles="army.battleProfiles"
        :armyName="list.faction"
        :listId="list.id" />
      <FactionTerrainSection
        v-model="list.factionTerrain"
        :battleProfiles="army.battleProfiles"
        :armyName="list.faction"
        :listId="list.id" />
      <!-- Lore Sections -->
      <ListBuilderLoreSection
        :armyLore="army.spellLores"
        :armyName="list.faction"
        title="Spell Lore"
        v-model="list.spellLore" />
      <ListBuilderLoreSection
        :armyLore="army.prayerLores"
        :armyName="list.faction"
        title="Prayer Lore"
        v-model="list.prayerLore" />
      <ListBuilderLoreSection
        :armyLore="army.manifestationLores"
        :armyName="list.faction"
        title="Manifestation Lore"
        v-model="list.manifestationLore"
        manifestationMode />
    </div>
    <div class="scroll-buffer"></div>
  </div>
  <ListIndicator v-if="list && game" :list="list" :game="game" />
</template>

<script setup lang="ts">
import OptionSelect from '../../core/components/OptionSelect.vue';
import { ref, computed } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { useList } from '../../shared/composables/useList';
import BackButton from '../../core/components/BackButton.vue';
import SettingsButton from '../../core/components/SettingsButton.vue';
import CircleIconButton from '../../core/components/CircleIconButton.vue';
import { useGame } from '../../shared/composables/useGame';
import Section from '../../core/components/Section.vue';
import AbilityCard from '../../shared/components/AbilityCard.vue';
import ListBuilderLoreSection from '../components/ListBuilderLoreSection.vue';
import ListIndicator from '../components/ListIndicator.vue';
import ListRegiment from '../components/ListRegiment.vue';
import BattleTacticCard from '../../shared/components/BattleTacticCard.vue';
import FactionTerrainSection from '../components/FactionTerrainSection.vue';
import AuxiliaryUnitsSection from '../components/AuxiliaryUnitsSection.vue';
import { Army } from '../../../parser/models/army';
import { BattleTacticCard as BattleTacticCardModel } from '../../../parser/models/game';
import { ListUnit } from '../../../list/models/unit';
import { ListRegiment as ListRegimentModel } from '../../../list/models/regiment';

const props = defineProps<{ id: string }>();
const route = useRoute();
const router = useRouter();
const listId = props.id ?? (route.params.id as string);
const list = useList(listId);
const { game, loading } = useGame();
const army = computed(() => {
  return game.value?.armies.get(list.value?.faction || '') || new Army();
});
const selectedFormation = computed(() => {
  return army.value.formations.get(list.value.formation) || [];
});
const selectedBattleTacticCard1 = computed(() => {
  return (
    battleTacticCards.value.find((card) => card.name === list.value.battleTacticCard1) ||
    new BattleTacticCardModel()
  );
});
const selectedBattleTacticCard2 = computed(() => {
  return (
    battleTacticCards.value.find((card) => card.name === list.value.battleTacticCard2) ||
    new BattleTacticCardModel()
  );
});

const battleTraitsCollapsed = ref(true);
const formationCollapsed = ref(true);
const battleTacticCardsCollapsed = ref(true);
const battleTacticCards = computed(() => {
  return game.value?.battleTacticCards || [];
});

function addRegiment() {
  list.value.regiments.push(new ListRegimentModel());
}
function openSettings() {
  router.push({ name: 'BuilderSettings', params: { id: listId } });
}
function openExport() {
  router.push({ name: 'ListExport', params: { id: listId } });
}
function deleteRegiment(idx: number) {
  list.value.regiments.splice(idx, 1);
}
function handleDeleteUnit(regimentIdx: number, unitIdx: number | string) {
  if (!list.value.regiments[regimentIdx]) return;
  if (unitIdx === 'leader') {
    list.value.regiments[regimentIdx].leader = new ListUnit();
  } else if (typeof unitIdx === 'number') {
    list.value.regiments[regimentIdx].units.splice(unitIdx, 1);
  }
}
</script>
<style scoped>
@import './listbuilder.css';
.battle-tactic-selectors {
  display: flex;
  gap: 2em;
  flex-wrap: wrap;
  margin-bottom: 1em;
}
.battle-tactic-selector {
  flex: 1 1 250px;
  min-width: 220px;
  max-width: 350px;
  display: flex;
  flex-direction: column;
  gap: 0.7em;
}
</style>
