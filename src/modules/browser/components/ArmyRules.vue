<template>
  <div>
    <!-- FAQ Section -->
    <Section
      v-if="armyFAQData && armyFAQData.data && armyFAQData.data.length > 0"
      :default-collapsed="true"
      collapse-key="army-faq"
    >
      <template #title>FAQ</template>
      <div v-if="faqLoading">Loading FAQ...</div>
      <div v-else-if="faqError" class="error">{{ faqError }}</div>
      <div v-else-if="armyFAQData">
        <i class="faq-warning">Only FAQs that directly references this army appear here, it may not be all relevant FAQs.</i>
        <FAQSection
          v-for="(section, i) in armyFAQData.data"
          :key="'army-faq-section-' + i"
          :section="section"
        />
      </div>
    </Section>
    
    <Section
      v-if="army.hasDetails()"
      collapse-key="details"
    >
      <template #title>Details</template>

      <ul v-if="army.battleTraitNotes.length" class="details-list">
        <li v-for="(note, index) in army.battleTraitNotes" :key="index" v-html="formatText(note)"></li>
      </ul>
      <ul v-if="army.armyKeyword" class="details-list">
        <li v-html="formatArmyKeywordText(army.armyKeyword)"></li>
      </ul>
      <ul v-if="army.options.length" class="details-list" v-html="formatArmyOptions(army.options)">
      </ul>
    </Section>
    <Section
      v-if="army.battleTraits && army.battleTraits.length"
      collapse-key="battleTraits"
    >
      <template #title>Battle Traits</template>
      <AbilityCard
        v-for="(trait, i) in army.battleTraits"
        :key="trait.name + i"
        :ability="trait"
      />
    </Section>
    <Section
      v-if="army.formations && army.formations.size"
      collapse-key="formations"
    >
      <template #title>Formations</template>
      <div
        v-for="[formationName, formation] in Array.from(army.formations.entries())"
        :key="formationName"
      >
        <h3 class="section-subheader">{{ formationName }}<BadgeRow inline><SoGBadge :sog="formation.sog" /><PointsBadge :points="formation.points" /></BadgeRow></h3>
        <AbilityCard
          v-for="(ability, i) in formation.abilities"
          :key="ability.name + i"
          :ability="ability"
        />
      </div>
    </Section>
    <Section
      v-if="army.artifacts && army.artifacts.size"
      collapse-key="artifacts"
    >
      <template #title>Artifacts</template>
      <div
        v-for="[group, table] in Array.from(army.artifacts.entries())"
        :key="group"
      >
        <h3 class="section-subheader">{{ table.name }}<BadgeRow inline><SoGBadge :sog="table.sog" /></BadgeRow></h3>
        <AbilityCard
          v-for="(enh, j) in table.enhancements"
          :key="enh.ability.name + j"
          :ability="enh.ability"
          :points="enh.points"
        />
      </div>
    </Section>
    <Section
      v-if="army.heroicTraits && army.heroicTraits.size"
      collapse-key="heroicTraits"
    >
      <template #title>Heroic Traits</template>
      <div
        v-for="[group, table] in Array.from(army.heroicTraits.entries())"
        :key="group"
      >
        <h3 class="section-subheader">{{ table.name }}<BadgeRow inline><SoGBadge :sog="table.sog" /></BadgeRow></h3>
        <AbilityCard
          v-for="(enh, j) in table.enhancements"
          :key="enh.ability.name + j"
          :ability="enh.ability"
          :points="enh.points"
        />
      </div>
    </Section>
    <Section
      v-if="army.enhancements && army.enhancements.size"
      collapse-key="enhancements"
    >
      <template #title>Enhancements</template>
      <div
        v-for="[table, enhTable] in Array.from(army.enhancements.entries())"
        :key="table"
      >
        <h3 class="section-subheader">{{ enhTable.name }}<BadgeRow inline><SoGBadge :sog="enhTable.sog" /></BadgeRow></h3>
        <span v-if="enhTable.keywords.length" class="enhancement-keywords" v-html="formatEnhancementKeywords(enhTable)"></span>
        <AbilityCard
          v-for="(enh, i) in enhTable.enhancements"
          :key="enh.ability.name + i"
          :ability="enh.ability"
          :points="enh.points"
        />
      </div>
    </Section>
    <!-- Spell Lores Dropdown -->
    <Section
      v-if="Array.from(army.spellLores.values()).length"
      collapse-key="spellLores"
    >
      <template #title>Spell Lores</template>
      <div v-if="Array.from(army.spellLores.values()).length === 1">
        <h3 class="section-subheader">
          {{ Array.from(army.spellLores.values())[0].name}}
        </h3>
        <PointsBadge big :points="Array.from(army.spellLores.values())[0].points" />
        <AbilityCard
          v-for="(ability, i) in Array.from(army.spellLores.values())[0].abilities"
          :key="ability.name + i"
          :ability="ability"
        />
      </div>
      <div v-else>
        <OptionSelect
          v-model="selectedSpellLore"
          :options="Array.from(army.spellLores.values()).map((lore) => lore.name)"
        />
        <!--- add points badge here -->
        <div v-if="selectedSpellLore">
          <PointsBadge big :points="army.spellLores.get(selectedSpellLore)?.points" />
          <AbilityCard
            v-for="(ability, i) in army.spellLores.get(selectedSpellLore)?.abilities || []"
            :key="ability.name + i"
            :ability="ability"
          />
        </div>
      </div>
    </Section>
    <!-- Prayer Lores Dropdown -->
    <Section
      v-if="Array.from(army.prayerLores.values()).length"
      collapse-key="prayerLores"
    >
      <template #title>Prayer Lores</template>
      <div v-if="Array.from(army.prayerLores.values()).length === 1">
        <h3 class="section-subheader">
          {{ Array.from(army.prayerLores.values())[0].name }}
        </h3>
        <PointsBadge big :points="Array.from(army.prayerLores.values())[0].points" />
        <AbilityCard
          v-for="(ability, i) in Array.from(army.prayerLores.values())[0].abilities"
          :key="ability.name + i"
          :ability="ability"
        />
      </div>
      <div v-else>
        <OptionSelect
          v-model="selectedPrayerLore"
          :options="Array.from(army.prayerLores.values()).map((lore) => lore.name)"
          class="lore-dropdown"
          placeholder="Select Prayer Lore"
        />
        <!-- points badge goes here -->
        <div v-if="selectedPrayerLore">
          <PointsBadge big :points="army.prayerLores.get(selectedPrayerLore)?.points" />
          <AbilityCard
            v-for="(ability, i) in army.prayerLores.get(selectedPrayerLore)?.abilities || []"
            :key="ability.name + i"
            :ability="ability"
          />
        </div>
      </div>
    </Section>
    <!-- Manifestation Lores Dropdown -->
    <Section
      v-if="Array.from(army.manifestationLores.values()).length"
      collapse-key="manifestationLores"
    >
      <template #title>Manifestation Lores</template>
      <div v-if="Array.from(army.manifestationLores.values()).length === 1">
        <h3 class="section-subheader">
          {{ Array.from(army.manifestationLores.values())[0].name }}
        </h3>
        <PointsBadge big :points="Array.from(army.manifestationLores.values())[0].points" />
        <AbilityCard
          v-for="(ability, i) in Array.from(army.manifestationLores.values())[0].abilities"
          :key="ability.name + i"
          :ability="ability"
        />
      </div>
      <div v-else>
        <OptionSelect
          v-model="selectedManifestationLore"
          :options="Array.from(army.manifestationLores.values()).map((lore) => lore.name)"
          class="lore-dropdown"
          placeholder="Select Manifestation Lore"
        />
        <div v-if="selectedManifestationLore">
          <PointsBadge big :points="army.manifestationLores.get(selectedManifestationLore)?.points" />
          <AbilityCard
            v-for="(ability, i) in army.manifestationLores.get(selectedManifestationLore)
              ?.abilities || []"
            :key="ability.name + i"
            :ability="ability"
          />
        </div>
      </div>
    </Section>
    <ReportErrorButton 
    :army-name="army.name"
    :army-revision="army.revision"/>
  </div>
</template>

<script setup lang="ts">
import { ref, watch, computed } from 'vue';
import OptionSelect from '../../core/components/OptionSelect.vue';
import type { Army } from '../../../parser/models/army';
import AbilityCard from '../../shared/components/AbilityCard.vue';
import Section from '../../core/components/ContentSection.vue';
import { formatArmyOptions, formatText } from '../../../utils/formatter';
import ReportErrorButton from '../../shared/components/ReportErrorButton.vue';
import PointsBadge from '../../shared/components/badges/PointsBadge.vue';
import SoGBadge from '../../shared/components/badges/SoGBadge.vue';
import BadgeRow from '../../shared/components/badges/BadgeRow.vue';
import FAQSection from '../../shared/faq/FAQSection.vue';
import { useFAQ } from '../../shared/composables/useFAQ';
import { useFAQSearch } from '../../shared/composables/useFAQSearch';

const props = defineProps<{ army: Army }>();

// Load FAQ data
const { faq: faqData, loading: faqLoading, error: faqError } = useFAQ();

// Use baseArmyName if available (for Army of Renown), otherwise use the army name
const searchQueries = computed(() => {
  const aorName = props.army.name.split(' - ')[1];
  if (aorName) return [props.army.baseArmyName, aorName];
  return [props.army.baseArmyName];
});

// Filter FAQ data by army name
const armyFAQData = useFAQSearch(faqData, searchQueries);

function formatArmyKeywordText(keyword: string): string {
  return formatText(`All units in this army gain the **^^${keyword}^^** keyword.`);
}

function formatEnhancementKeywords(enhTable: any): string {
  const keywords = enhTable.keywords.map((kw: string) => `**^^${kw}^^**`).join(' ');
  return formatText(`${keywords} only`);
}

const selectedSpellLore = ref<string>('');
const selectedPrayerLore = ref<string>('');
const selectedManifestationLore = ref<string>('');

// Set default selected lore when army changes
watch(
  () => [props.army],
  () => {
    if (!selectedSpellLore.value && props.army.spellLores.size > 0) {
      selectedSpellLore.value = props.army.spellLores.values().next().value?.name || '';
    }
    if (!selectedPrayerLore.value && props.army.prayerLores.size > 0) {
      selectedPrayerLore.value = props.army.prayerLores.values().next().value?.name || '';
    }
    if (!selectedManifestationLore.value && props.army.manifestationLores.size > 0) {
      selectedManifestationLore.value =
        props.army.manifestationLores.values().next().value?.name || '';
    }
  },
  { immediate: true }
);
</script>

<style scoped>
.details-list {
  margin: 0 0 1em 0;
  padding-left: 1.2em;
  list-style: disc inside;
}
.details-list strong {
  font-weight: bold;
}
.lore-dropdown {
  margin-bottom: 1em;
  font-size: 1.1em;
  padding: 0.4em 1em;
  border-radius: 4px;
  border: 1.5px solid #222;
  background: #f9f9f9;
}
.section-subheader {
  text-align: left;
}
.error {
  color: #c00;
  text-align: center;
  margin-top: 1rem;
}
.faq-warning {
  color: var(--text-muted);
  font-size: 0.9em;
  margin-top: 0.5em;
  display: block;
}
</style>
